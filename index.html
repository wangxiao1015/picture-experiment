<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åå¥½æ’åºä¸é€‰æ‹©å®éªŒ</title>
    <style>
        /* ========== åŸºç¡€ä¸å…¨å±€æ ·å¼ ========== */
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }
        #experiment-container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            padding: 0;
        }

        /* ========== å¤´éƒ¨æ ‡é¢˜åŒºåŸŸ ========== */
        .header {
            background: linear-gradient(135deg, #4a69bd 0%, #2d3a8c 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 1.8em;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95em;
        }

        /* ========== ä¸»å†…å®¹åŒºé€šç”¨æ ·å¼ ========== */
        .main-content {
            padding: 30px;
        }
        .stage-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #4a69bd;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
        }
        .instructions p {
            margin: 10px 0;
        }

        /* ========== æ’åºä»»åŠ¡ä¸“å±å¸ƒå±€ ========== */
        .sorting-interface {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        @media (max-width: 1000px) {
            .sorting-interface {
                flex-direction: column;
            }
        }

        /* æ’åºåŒºä¸å›¾ç‰‡æ± çš„é€šç”¨é¢æ¿æ ·å¼ */
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .panel-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            padding: 15px 0 10px;
            text-align: center;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
        }

        /* ç½‘æ ¼å®¹å™¨ */
        .grid-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 12px;
            min-height: 500px;
        }

        /* ========== æ’åºæ§½æ ·å¼ ========== */
        .rank-slot {
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 2px solid #d1d9e6;
        }
        .rank-slot.empty {
            border-style: dashed;
            background-color: #f8fafc;
        }
        .rank-slot.filled {
            border-color: #38b2ac;
            border-style: solid;
        }
        .rank-slot.drag-over {
            border-color: #f56565;
            background-color: #fff5f5;
            transform: scale(1.02);
        }
        .slot-header {
            padding: 10px 5px;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e2e8f0;
        }
        .rank-number {
            font-size: 1.4em;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1;
        }
        .rank-text {
            font-size: 0.75em;
            color: #718096;
            margin-top: 3px;
        }
        .slot-image {
            flex: 1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 120px;
        }

        /* ========== å¯æ‹–æ‹½å›¾ç‰‡æ ·å¼ ========== */
        .draggable-img {
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 8px rgba(66, 153, 225, 0.2);
            border: 3px solid #4299e1;
        }
        .draggable-img.in-pool:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(66, 153, 225, 0.3);
            border-color: #3182ce;
        }
        .draggable-img.dragging {
            opacity: 0.8;
            cursor: grabbing;
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            position: relative;
        }
        .draggable-img.in-slot {
            border-color: #38b2ac;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
        }

        /* ========== é€‰æ‹©ä»»åŠ¡æ ·å¼ ========== */
        .choice-options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            margin: 30px 0;
        }
        .choice-option {
            width: 150px;
            height: 210px;
            border-radius: 10px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            border: 4px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .choice-option:hover {
            transform: scale(1.08);
            border-color: #9f7aea;
        }
        .choice-option.selected {
            border-color: #00b5d8;
            box-shadow: 0 0 0 4px rgba(0, 181, 216, 0.3);
            transform: scale(1.05);
        }

        /* ========== æ§åˆ¶ä¸è¿›åº¦åŒºåŸŸ ========== */
        .control-area {
            text-align: center;
            padding: 25px;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        .progress-info {
            font-size: 1.1em;
            font-weight: bold;
            color: #2b6cb0;
            padding: 12px 25px;
            background-color: #ebf8ff;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 20px;
            border: 1px solid #bee3f8;
        }
        .progress-info.complete {
            background-color: #f0fff4;
            color: #276749;
            border-color: #c6f6d5;
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .action-button {
            background: linear-gradient(135deg, #4a69bd 0%, #2d3a8c 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(74, 105, 189, 0.3);
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 7px 18px rgba(74, 105, 189, 0.4);
        }
        .action-button:active:not(:disabled) {
            transform: translateY(-1px);
        }
        .action-button:disabled {
            background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ========== å®Œæˆé¡µé¢æ ·å¼ ========== */
        .completion-screen {
            text-align: center;
            padding: 60px 30px;
        }
        .completion-icon {
            font-size: 4em;
            color: #38a169;
            margin-bottom: 20px;
        }
        .data-summary {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin: 30px auto;
            max-width: 600px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }
        .data-summary h3 {
            color: #2d3748;
            margin-top: 0;
            border-bottom: 2px solid #4a69bd;
            padding-bottom: 10px;
        }
        .download-note {
            color: #e53e3e;
            font-weight: bold;
            margin-top: 30px;
            padding: 15px;
            background-color: #fff5f5;
            border-radius: 8px;
            border-left: 4px solid #e53e3e;
        }
    </style>
</head>
<body>
    <!-- å®éªŒçš„ä¸»å®¹å™¨ï¼Œæ‰€æœ‰å†…å®¹åŠ¨æ€åŠ è½½äºæ­¤ -->
    <div id="experiment-container"></div>

    <script>
        // ==================== å®éªŒé…ç½®ä¸å…¨å±€çŠ¶æ€ ====================
        const CONFIG = {
            // æ‚¨çš„12å¼ å›¾ç‰‡URL
            imageUrls: [
                'poster_1.png',
                'poster_2.png',
                'poster_3.png',
                'poster_4.png',
                'poster_5.png',
                'poster_6.png',
                'poster_7.png',
                'poster_8.png',
                'poster_9.png',
                'poster_10.png',
                'poster_11.png',
                'poster_12.png'
            ],
            // æ’åºæ§½ä½å®šä¹‰
            rankSlots: [
                { rank: 1, text: 'æœ€å–œæ¬¢' },
                { rank: 2, text: 'ç¬¬2å–œæ¬¢' },
                { rank: 3, text: 'ç¬¬3å–œæ¬¢' },
                { rank: 4, text: 'ç¬¬4å–œæ¬¢' },
                { rank: 5, text: 'ç¬¬5å–œæ¬¢' },
                { rank: 6, text: 'ç¬¬6å–œæ¬¢' },
                { rank: 7, text: 'ç¬¬7å–œæ¬¢' },
                { rank: 8, text: 'ç¬¬8å–œæ¬¢' },
                { rank: 9, text: 'ç¬¬9å–œæ¬¢' },
                { rank: 10, text: 'ç¬¬10å–œæ¬¢' },
                { rank: 11, text: 'ç¬¬11å–œæ¬¢' },
                { rank: 12, text: 'æœ€ä¸å–œæ¬¢' }
            ]
        };

        // å…¨å±€å®éªŒæ•°æ®å¯¹è±¡
        const EXPERIMENT = {
            // === æ—¶é—´è®°å½• ===
            timestamps: {
                experimentStart: null,      // å®éªŒå¼€å§‹
                sortingStart: null,         // æ’åºé˜¶æ®µå¼€å§‹
                sortingEnd: null,           // æ’åºé˜¶æ®µç»“æŸ
                choiceStart: null,          // é€‰æ‹©é˜¶æ®µå¼€å§‹
                choiceEnd: null             // é€‰æ‹©é˜¶æ®µç»“æŸ
            },
            // === æ ¸å¿ƒç»“æœ ===
            finalRanking: new Array(12).fill(null), // è®°å½•æ¯å¼ å›¾ç‰‡çš„æœ€ç»ˆæ’å(1-12)ï¼Œnullè¡¨ç¤ºæœªæ’åº
            selectedImageId: null,          // è¢«é€‰ä¸ºå°é¢çš„å›¾ç‰‡ID (0-11)
            // === è¿‡ç¨‹æ•°æ® ===
            dragEvents: [],                 // è®°å½•æ¯æ¬¡æ‹–æ‹½äº‹ä»¶ï¼ˆå¯é€‰ï¼‰
            isSortingComplete: false        // æ’åºæ˜¯å¦å®Œæˆæ ‡è®°
        };

        // å½“å‰å®éªŒé˜¶æ®µ
        let currentStage = 'instructions'; // instructions, sorting, choice, finish

        // ==================== å·¥å…·å‡½æ•° ====================
        /**
         * å°†æ•°æ®ä¿å­˜ä¸ºJSONæ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
         * @param {Object} data - è¦ä¿å­˜çš„æ•°æ®å¯¹è±¡
         * @param {string} filename - æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
         */
        function saveDataAsJSON(data, filename = null) {
            // ç”Ÿæˆå¸¦æœ‰æ—¶é—´æˆ³çš„é»˜è®¤æ–‡ä»¶å
            if (!filename) {
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                filename = `å®éªŒæ•°æ®_${timestamp}.json`;
            }

            // åˆ›å»ºæ•°æ®å­—ç¬¦ä¸²
            const dataStr = JSON.stringify(data, null, 2); // ç¼©è¿›2æ ¼ï¼Œæ–¹ä¾¿é˜…è¯»
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ç‚¹å‡»
            const downloadUrl = URL.createObjectURL(dataBlob);
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;

            // æ·»åŠ åˆ°é¡µé¢ï¼Œç‚¹å‡»ï¼Œç„¶åæ¸…ç†
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // é‡Šæ”¾å†…å­˜
            setTimeout(() => URL.revokeObjectURL(downloadUrl), 100);
        }

        /**
         * å‡†å¤‡æœ€ç»ˆè¦ä¿å­˜çš„æ•°æ®
         */
        function prepareFinalData() {
            // è®¡ç®—å„é˜¶æ®µè€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰
            const sortingDuration = EXPERIMENT.timestamps.sortingEnd && EXPERIMENT.timestamps.sortingStart ?
                (EXPERIMENT.timestamps.sortingEnd - EXPERIMENT.timestamps.sortingStart) / 1000 : null;
            const choiceDuration = EXPERIMENT.timestamps.choiceEnd && EXPERIMENT.timestamps.choiceStart ?
                (EXPERIMENT.timestamps.choiceEnd - EXPERIMENT.timestamps.choiceStart) / 1000 : null;
            const totalDuration = EXPERIMENT.timestamps.experimentStart ?
                (Date.now() - EXPERIMENT.timestamps.experimentStart) / 1000 : null;

            // æ„å»ºæœ€ç»ˆæ•°æ®å¯¹è±¡
            return {
                // åŸºæœ¬ä¿¡æ¯
                participant_id: `anonymous_${Date.now()}`,
                completion_time: new Date().toISOString(),

                // æ—¶é—´æ•°æ®
                timestamps: {
                    experiment_start: EXPERIMENT.timestamps.experimentStart,
                    sorting_start: EXPERIMENT.timestamps.sortingStart,
                    sorting_end: EXPERIMENT.timestamps.sortingEnd,
                    choice_start: EXPERIMENT.timestamps.choiceStart,
                    choice_end: EXPERIMENT.timestamps.choiceEnd
                },
                durations_seconds: {
                    sorting_stage: sortingDuration,
                    choice_stage: choiceDuration,
                    total_experiment: totalDuration
                },

                // æ ¸å¿ƒç»“æœæ•°æ®
                final_ranking: EXPERIMENT.finalRanking,
                selected_image: {
                    id: EXPERIMENT.selectedImageId,
                    url: EXPERIMENT.selectedImageId !== null ?
                        CONFIG.imageUrls[EXPERIMENT.selectedImageId] : null
                },

                // è¿‡ç¨‹æ•°æ®
                drag_events_count: EXPERIMENT.dragEvents.length,
                drag_events: EXPERIMENT.dragEvents, // åŒ…å«è¯¦ç»†æ‹–æ‹½è®°å½•

                // å®éªŒé…ç½®ä¿¡æ¯
                config: {
                    total_images: CONFIG.imageUrls.length,
                    image_urls: CONFIG.imageUrls
                }
            };
        }

        // ==================== é˜¶æ®µä¸€ï¼šæ˜¾ç¤ºæŒ‡å¯¼è¯­ ====================
        function showInstructions() {
            currentStage = 'instructions';
            EXPERIMENT.timestamps.experimentStart = Date.now();

            const html = `
                <div class="header">
                    <h1>å›¾ç‰‡åå¥½å®éªŒ</h1>
                    <p>è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹è¯´æ˜ï¼Œç„¶åå¼€å§‹å®éªŒ</p>
                </div>
                <div class="main-content">
                    <div class="instructions">
                        <h2>å®éªŒç›®çš„</h2>
                        <p>æˆ‘ä»¬å°†æ ¹æ®æ‚¨çš„å›¾ç‰‡å–œå¥½æ’åºï¼Œä¸ºæ‚¨åˆ¶ä½œä¸€ä¸ªä¸“å±å°é¢çš„ç¬”è®°æœ¬ã€‚</p>
                        
                        <h2>ä»»åŠ¡æµç¨‹</h2>
                        <ol>
                            <li><strong>æ’åºé˜¶æ®µ</strong>ï¼šå°†å³ä¾§çš„12å¼ å›¾ç‰‡ï¼ŒæŒ‰ç…§æ‚¨çš„ä¸ªäººå–œå¥½ï¼Œä»<b>æœ€å–œæ¬¢ï¼ˆ1ï¼‰</b>åˆ°<b>æœ€ä¸å–œæ¬¢ï¼ˆ12ï¼‰</b>æ‹–æ‹½åˆ°å·¦ä¾§çš„æ’åºåŒºã€‚</li>
                            <li><strong>é€‰æ‹©é˜¶æ®µ</strong>ï¼šå®Œæˆæ’åºåï¼Œæ‚¨å°†ä»éƒ¨åˆ†å›¾ç‰‡ä¸­æŒ‘é€‰ä¸€å¼ ä½œä¸ºç¬”è®°æœ¬çš„æœ€ç»ˆå°é¢ã€‚</li>
                        </ol>
                        
                        <h2>æ“ä½œè¯´æ˜</h2>
                        <ul>
                            <li><b>æ‹–æ‹½æ’åº</b>ï¼šç‚¹å‡»å›¾ç‰‡æ± ä¸­çš„å›¾ç‰‡å¹¶æŒ‰ä½ï¼Œæ‹–æ‹½åˆ°å·¦ä¾§æ’åºåŒºçš„ä»»æ„ä½ç½®ã€‚</li>
                            <li><b>è°ƒæ•´é¡ºåº</b>ï¼šæ‚¨å¯ä»¥éšæ—¶å°†å·²æ’åºçš„å›¾ç‰‡æ‹–åˆ°æ–°çš„ä½ç½®ï¼Œæˆ–æ‹–å›å›¾ç‰‡æ± ã€‚</li>
                            <li><b>å®Œæˆè¦æ±‚</b>ï¼šå¿…é¡»å°†å…¨éƒ¨12å¼ å›¾ç‰‡æ”¾å…¥æ’åºåŒºåï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li>
                        </ul>
                        
                        <p style="margin-top: 25px; color: #4a5568; font-style: italic;">
                            å»ºè®®ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨ï¼Œå¹¶åœ¨ç”µè„‘ä¸Šå®Œæˆå®éªŒï¼Œä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button id="start-btn" class="action-button">æˆ‘æ˜ç™½äº†ï¼Œå¼€å§‹æ’åº</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            document.getElementById('start-btn').addEventListener('click', showSortingStage);
        }

        // ==================== é˜¶æ®µäºŒï¼šæ’åºä»»åŠ¡ ====================
        function showSortingStage() {
            currentStage = 'sorting';
            EXPERIMENT.timestamps.sortingStart = Date.now();

            // ç”Ÿæˆæ’åºæ§½ä½çš„HTML
            let slotsHTML = '';
            CONFIG.rankSlots.forEach(slot => {
                slotsHTML += `
                    <div class="rank-slot empty" data-rank="${slot.rank}" id="slot-${slot.rank}">
                        <div class="slot-header">
                            <div class="rank-number">${slot.rank}</div>
                            <div class="rank-text">${slot.text}</div>
                        </div>
                        <div class="slot-image" id="img-in-slot-${slot.rank}"></div>
                    </div>
                `;
            });

            // ç”Ÿæˆå›¾ç‰‡æ± çš„HTML
            let poolHTML = '';
            CONFIG.imageUrls.forEach((url, index) => {
                poolHTML += `
                    <div class="draggable-img in-pool" 
                         id="img-${index}"
                         data-id="${index}"
                         style="background-image: url('${url}')">
                    </div>
                `;
            });

            const html = `
                <div class="header">
                    <h1>ç¬¬ä¸€æ­¥ï¼šå›¾ç‰‡æ’åº</h1>
                    <p>è¯·ä»æœ€å–œæ¬¢ï¼ˆ1ï¼‰åˆ°æœ€ä¸å–œæ¬¢ï¼ˆ12ï¼‰ä¸ºå›¾ç‰‡æ’åº</p>
                </div>
                <div class="main-content">
                    <div class="sorting-interface">
                        <!-- å·¦ä¾§ï¼šæ’åºåŒº -->
                        <div class="panel">
                            <div class="panel-title">ğŸ† æ’åºåŒº</div>
                            <div class="grid-container" id="sorting-area">
                                ${slotsHTML}
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šå›¾ç‰‡æ±  -->
                        <div class="panel">
                            <div class="panel-title">ğŸ“š å›¾ç‰‡æ± ï¼ˆå…±12å¼ ï¼‰</div>
                            <div class="grid-container" id="image-pool">
                                ${poolHTML}
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-area">
                        <div id="progress-display" class="progress-info">å·²æ’åºï¼š0 / 12 å¼ å›¾ç‰‡</div>
                        <button id="continue-btn" class="action-button" disabled>å®Œæˆæ’åºï¼Œè¿›å…¥ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            
            // è®¾ç½®æ‹–æ‹½äº‹ä»¶ç›‘å¬
            setupDragAndDrop();
            
            // è®¾ç½®ç»§ç»­æŒ‰é’®äº‹ä»¶
            document.getElementById('continue-btn').addEventListener('click', () => {
                EXPERIMENT.timestamps.sortingEnd = Date.now();
                showChoiceInstructions();
            });
            
            // åˆå§‹æ›´æ–°è¿›åº¦æ˜¾ç¤º
            updateProgressDisplay();
        }

        // ==================== æ‹–æ‹½åŠŸèƒ½å®ç° ====================
        function setupDragAndDrop() {
            let draggedElement = null;
            let dragOffset = { x: 0, y: 0 };
            let dragGhost = null;

            // é¼ æ ‡æŒ‰ä¸‹ï¼šå¼€å§‹æ‹–æ‹½
            document.addEventListener('mousedown', function(e) {
                const imgElement = e.target.closest('.draggable-img.in-pool');
                if (!imgElement) return;
                
                e.preventDefault();
                draggedElement = imgElement;
                
                // è®¡ç®—é¼ æ ‡åœ¨å…ƒç´ å†…çš„åç§»é‡
                const rect = imgElement.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                // åˆ›å»ºæ‹–æ‹½æ—¶çš„"å¹½çµ"å›¾åƒï¼ˆè§†è§‰åé¦ˆï¼‰
                dragGhost = imgElement.cloneNode(true);
                dragGhost.classList.add('dragging');
                dragGhost.style.position = 'fixed';
                dragGhost.style.left = rect.left + 'px';
                dragGhost.style.top = rect.top + 'px';
                dragGhost.style.width = rect.width + 'px';
                dragGhost.style.height = rect.height + 'px';
                dragGhost.style.pointerEvents = 'none';
                dragGhost.style.zIndex = '10000';
                document.body.appendChild(dragGhost);
                
                // è®°å½•æ‹–æ‹½å¼€å§‹äº‹ä»¶
                EXPERIMENT.dragEvents.push({
                    type: 'drag_start',
                    imageId: parseInt(imgElement.dataset.id),
                    timestamp: Date.now() - EXPERIMENT.timestamps.experimentStart
                });
            });

            // é¼ æ ‡ç§»åŠ¨ï¼šæ›´æ–°å¹½çµä½ç½®å’Œé«˜äº®ç›®æ ‡
            const handleMouseMove = (e) => {
                if (!draggedElement || !dragGhost) return;
                
                // æ›´æ–°å¹½çµä½ç½®
                dragGhost.style.left = (e.clientX - dragOffset.x) + 'px';
                dragGhost.style.top = (e.clientY - dragOffset.y) + 'px';
                
                // é«˜äº®å¯èƒ½çš„ç›®æ ‡æ§½ä½
                document.querySelectorAll('.rank-slot').forEach(slot => {
                    const rect = slot.getBoundingClientRect();
                    const isOver = e.clientX >= rect.left && e.clientX <= rect.right &&
                                  e.clientY >= rect.top && e.clientY <= rect.bottom;
                    slot.classList.toggle('drag-over', isOver);
                });
            };

            // é¼ æ ‡é‡Šæ”¾ï¼šå¤„ç†æ”¾ç½®
            const handleMouseUp = (e) => {
                if (!draggedElement) return;
                
                // ç§»é™¤å¹½çµ
                if (dragGhost && dragGhost.parentNode) {
                    document.body.removeChild(dragGhost);
                }
                dragGhost = null;
                
                // ç§»é™¤æ‰€æœ‰é«˜äº®
                document.querySelectorAll('.rank-slot.drag-over').forEach(s => {
                    s.classList.remove('drag-over');
                });
                
                // æŸ¥æ‰¾æ”¾ç½®çš„ç›®æ ‡æ§½ä½
                let targetSlot = null;
                const slots = document.querySelectorAll('.rank-slot');
                
                for (const slot of slots) {
                    const rect = slot.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        targetSlot = slot;
                        break;
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°ç›®æ ‡æ§½ä½ï¼Œæ”¾ç½®å›¾ç‰‡
                if (targetSlot) {
                    placeImageInSlot(draggedElement, targetSlot);
                }
                
                // æ¸…ç†äº‹ä»¶ç›‘å¬
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                draggedElement = null;
            };

            // å½“å¼€å§‹æ‹–æ‹½æ—¶æ·»åŠ å…¨å±€ç›‘å¬
            document.addEventListener('mousedown', function startDragListener(e) {
                const imgElement = e.target.closest('.draggable-img.in-pool');
                if (imgElement) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    // ä¸€æ¬¡æ€§ç›‘å¬å™¨
                    document.addEventListener('mouseup', function removeListeners() {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                        document.removeEventListener('mouseup', removeListeners);
                    }, { once: true });
                }
            });
        }

        /**
         * å°†å›¾ç‰‡æ”¾å…¥æŒ‡å®šçš„æ’åºæ§½
         */
        function placeImageInSlot(imgElement, slotElement) {
            const imgId = parseInt(imgElement.dataset.id);
            const slotRank = parseInt(slotElement.dataset.rank);
            const slotImgElement = document.getElementById(`img-in-slot-${slotRank}`);
            
            // æƒ…å†µ1ï¼šç›®æ ‡æ§½å·²æœ‰å›¾ç‰‡ â†’ å…ˆæ¸…ç©º
            if (slotImgElement.style.backgroundImage) {
                for (let i = 0; i < EXPERIMENT.finalRanking.length; i++) {
                    if (EXPERIMENT.finalRanking[i] === slotRank) {
                        EXPERIMENT.finalRanking[i] = null;
                        const oldImg = document.getElementById(`img-${i}`);
                        if (oldImg) {
                            oldImg.classList.remove('in-slot');
                            oldImg.classList.add('in-pool');
                        }
                        break;
                    }
                }
            }
            
            // æƒ…å†µ2ï¼šè¿™å¼ å›¾ç‰‡åŸæœ¬å·²åœ¨å…¶ä»–æ§½ä¸­ â†’ æ¸…ç©ºåŸæ§½ä½
            const oldRank = EXPERIMENT.finalRanking[imgId];
            if (oldRank !== null) {
                document.getElementById(`img-in-slot-${oldRank}`).style.backgroundImage = '';
                document.getElementById(`slot-${oldRank}`).classList.remove('filled');
                document.getElementById(`slot-${oldRank}`).classList.add('empty');
            }
            
            // æ”¾å…¥æ–°å›¾ç‰‡
            EXPERIMENT.finalRanking[imgId] = slotRank;
            imgElement.classList.remove('in-pool');
            imgElement.classList.add('in-slot');
            slotImgElement.style.backgroundImage = `url('${CONFIG.imageUrls[imgId]}')`;
            slotElement.classList.remove('empty');
            slotElement.classList.add('filled');
            
            // è®°å½•æ‹–æ‹½å®Œæˆäº‹ä»¶
            EXPERIMENT.dragEvents.push({
                type: 'drop',
                imageId: imgId,
                fromRank: oldRank,
                toRank: slotRank,
                timestamp: Date.now() - EXPERIMENT.timestamps.experimentStart
            });
            
            // æ›´æ–°è¿›åº¦æ˜¾ç¤º
            updateProgressDisplay();
        }

        /**
         * æ›´æ–°æ’åºè¿›åº¦æ˜¾ç¤º
         */
        function updateProgressDisplay() {
            const filledCount = EXPERIMENT.finalRanking.filter(rank => rank !== null).length;
            const progressElement = document.getElementById('progress-display');
            const continueButton = document.getElementById('continue-btn');
            
            if (progressElement) {
                progressElement.textContent = `å·²æ’åºï¼š${filledCount} / 12 å¼ å›¾ç‰‡`;
                if (filledCount === 12) {
                    progressElement.textContent = 'âœ… æ’åºå®Œæˆï¼æ‚¨å¯ä»¥ç»§ç»­è°ƒæ•´ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»§ç»­ã€‚';
                    progressElement.classList.add('complete');
                    EXPERIMENT.isSortingComplete = true;
                } else {
                    progressElement.classList.remove('complete');
                    EXPERIMENT.isSortingComplete = false;
                }
            }
            
            if (continueButton) {
                continueButton.disabled = filledCount < 12;
            }
        }

        // ==================== é˜¶æ®µä¸‰ï¼šé€‰æ‹©ä»»åŠ¡æŒ‡å¯¼è¯­ ====================
        function showChoiceInstructions() {
            const html = `
                <div class="header">
                    <h1>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æœ€ç»ˆå°é¢</h1>
                    <p>ç”±äºåˆ¶ä½œé™åˆ¶ï¼Œæ‚¨åªèƒ½ä»ä»¥ä¸‹å›¾ç‰‡ä¸­é€‰æ‹©</p>
                </div>
                <div class="main-content">
                    <div class="instructions">
                        <h2>é€‰æ‹©è¯´æ˜</h2>
                        <p>æ‚¨å·²ç»å®Œæˆäº†12å¼ å›¾ç‰‡çš„æ’åºï¼Œéå¸¸æ„Ÿè°¢ï¼</p>
                        <p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ‚¨åˆ¶ä½œå®ä½“ç¬”è®°æœ¬ã€‚ç”±äºåº“å­˜é™åˆ¶ï¼Œæˆ‘ä»¬åªèƒ½æä¾› <b>æ‚¨æ’åç¬¬4åˆ°ç¬¬8çš„5å¼ å›¾ç‰‡</b> ä½œä¸ºå°é¢å¤‡é€‰ã€‚</p>
                        <p>è¯·æ‚¨ä»è¿™5å¼ å›¾ç‰‡ä¸­ï¼Œé€‰æ‹© <b>1å¼ </b> ä½œä¸ºæ‚¨ç¬”è®°æœ¬çš„æœ€ç»ˆå°é¢ã€‚</p>
                        <p style="color: #4a5568; margin-top: 15px; padding: 10px; background: #edf2f7; border-radius: 6px;">
                            <b>æ“ä½œæç¤ºï¼š</b> ç‚¹å‡»æ‚¨é€‰æ‹©çš„å›¾ç‰‡å³å¯é€‰ä¸­ï¼Œç„¶åç‚¹å‡»ç¡®è®¤æŒ‰é’®ã€‚
                        </p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button id="start-choice-btn" class="action-button">å¼€å§‹é€‰æ‹©å°é¢</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            document.getElementById('start-choice-btn').addEventListener('click', showChoiceStage);
        }

        // ==================== é˜¶æ®µå››ï¼šé€‰æ‹©ä»»åŠ¡ ====================
        function showChoiceStage() {
            currentStage = 'choice';
            EXPERIMENT.timestamps.choiceStart = Date.now();

            // ç¡®å®šç¬¦åˆæ¡ä»¶çš„å›¾ç‰‡ï¼ˆæ’å4-8ï¼‰
            const eligibleImages = [];
            EXPERIMENT.finalRanking.forEach((rank, imgId) => {
                if (rank >= 4 && rank <= 8) {
                    eligibleImages.push({ imgId, rank });
                }
            });
            
            // æŒ‰æ’åæ’åº
            eligibleImages.sort((a, b) => a.rank - b.rank);
            
            // ç”Ÿæˆé€‰æ‹©é¡¹HTML
            let choicesHTML = '';
            eligibleImages.forEach(item => {
                choicesHTML += `
                    <div class="choice-option"
                         data-id="${item.imgId}"
                         style="background-image: url('${CONFIG.imageUrls[item.imgId]}')">
                    </div>
                `;
            });

            const html = `
                <div class="header">
                    <h1>è¯·é€‰æ‹©æ‚¨çš„ç¬”è®°æœ¬å°é¢</h1>
                    <p>ç‚¹å‡»ä¸‹æ–¹æ‚¨æœ€å–œæ¬¢çš„ä¸€å¼ å›¾ç‰‡</p>
                </div>
                <div class="main-content">
                    <p style="text-align: center; color: #4a5568; margin-bottom: 20px;">
                        è¯·ä»ä»¥ä¸‹5å¼ å›¾ç‰‡ï¼ˆæ‚¨çš„ç¬¬4åˆ°ç¬¬8åï¼‰ä¸­é€‰æ‹©1å¼ ï¼š
                    </p>
                    
                    <div class="choice-options-container" id="choice-container">
                        ${choicesHTML}
                    </div>
                    
                    <div id="choice-feedback" style="text-align: center; min-height: 50px; margin: 20px 0;"></div>
                    
                    <div class="control-area">
                        <button id="confirm-choice-btn" class="action-button" disabled>ç¡®è®¤é€‰æ‹©</button>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
            
            // è®¾ç½®é€‰æ‹©äº‹ä»¶
            const choiceOptions = document.querySelectorAll('.choice-option');
            const confirmButton = document.getElementById('confirm-choice-btn');
            const feedbackElement = document.getElementById('choice-feedback');
            
            choiceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // å–æ¶ˆä¹‹å‰çš„é€‰æ‹©
                    choiceOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // æ ‡è®°å½“å‰é€‰æ‹©
                    this.classList.add('selected');
                    
                    // è®°å½•é€‰æ‹©
                    EXPERIMENT.selectedImageId = parseInt(this.dataset.id);
                    
                    // æ˜¾ç¤ºåé¦ˆ
                    feedbackElement.innerHTML = `
                        <div style="color: #38a169; font-weight: bold; padding: 10px; background: #f0fff4; border-radius: 8px;">
                            âœ… æ‚¨å·²é€‰æ‹©æ­¤å›¾ç‰‡ä½œä¸ºå°é¢ã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç¡®è®¤ã€‚
                        </div>
                    `;
                    
                    // å¯ç”¨ç¡®è®¤æŒ‰é’®
                    confirmButton.disabled = false;
                });
            });
            
            // ç¡®è®¤æŒ‰é’®äº‹ä»¶
            confirmButton.addEventListener('click', () => {
                EXPERIMENT.timestamps.choiceEnd = Date.now();
                finishExperiment();
            });
        }

        // ==================== é˜¶æ®µäº”ï¼šå®Œæˆå®éªŒ ====================
        function finishExperiment() {
            currentStage = 'finish';
            
            // å‡†å¤‡æœ€ç»ˆæ•°æ®
            const finalData = prepareFinalData();
            
            // è‡ªåŠ¨ä¿å­˜æ•°æ®æ–‡ä»¶
            saveDataAsJSON(finalData);
            
            // æ˜¾ç¤ºå®Œæˆç•Œé¢
            const html = `
                <div class="header" style="background: linear-gradient(135deg, #38a169 0%, #276749 100%);">
                    <h1>âœ… å®éªŒå®Œæˆï¼</h1>
                    <p>æ„Ÿè°¢æ‚¨çš„è®¤çœŸå‚ä¸</p>
                </div>
                <div class="main-content">
                    <div class="completion-screen">
                        <div class="completion-icon">âœ…</div>
                        <h2>å®éªŒå·²æˆåŠŸå®Œæˆ</h2>
                        <p>æ‚¨çš„æ’åºä¸é€‰æ‹©æ•°æ®å·²è®°å½•ã€‚</p>
                        <p>æˆ‘ä»¬å°†æ ¹æ®æ‚¨çš„é€‰æ‹©ä¸ºæ‚¨åˆ¶ä½œä¸“å±å°é¢çš„ç¬”è®°æœ¬ã€‚</p>
                        
                        <div class="data-summary">
                            <h3>æ‚¨çš„å®éªŒæ•°æ®æ‘˜è¦</h3>
                            <p><strong>é€‰æ‹©çš„å°é¢å›¾ç‰‡ï¼š</strong> å›¾ç‰‡ #${EXPERIMENT.selectedImageId + 1}</p>
                            <p><strong>æ’åºè€—æ—¶ï¼š</strong> ${((EXPERIMENT.timestamps.sortingEnd - EXPERIMENT.timestamps.sortingStart)/1000).toFixed(1)} ç§’</p>
                            <p><strong>é€‰æ‹©è€—æ—¶ï¼š</strong> ${((EXPERIMENT.timestamps.choiceEnd - EXPERIMENT.timestamps.choiceStart)/1000).toFixed(1)} ç§’</p>
                            <p><strong>æ€»å®éªŒæ—¶é—´ï¼š</strong> ${((Date.now() - EXPERIMENT.timestamps.experimentStart)/1000).toFixed(1)} ç§’</p>
                            <p><strong>æ‹–æ‹½æ“ä½œæ¬¡æ•°ï¼š</strong> ${EXPERIMENT.dragEvents.filter(e => e.type === 'drop').length} æ¬¡</p>
                        </div>
                        
                        <div class="download-note">
                            <p>ğŸ“¥ <strong>é‡è¦æç¤ºï¼š</strong> æ‚¨çš„å®éªŒæ•°æ®æ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½ã€‚</p>
                            <p>æ–‡ä»¶åé€šå¸¸ä¸º <code>å®éªŒæ•°æ®_æ—¥æœŸæ—¶é—´.json</code>ï¼Œè¯·æ£€æŸ¥æ‚¨çš„"ä¸‹è½½"æ–‡ä»¶å¤¹ã€‚</p>
                            <p>è¯·å°†æ­¤æ–‡ä»¶é€šè¿‡é‚®ä»¶æˆ–å…¶ä»–æŒ‡å®šæ–¹å¼å‘é€ç»™å®éªŒä¸»æŒäººã€‚</p>
                        </div>
                        
                        <p style="color: #718096; margin-top: 40px; font-size: 0.9em;">
                            æ‚¨å¯ä»¥å®‰å…¨å…³é—­æ­¤æµè§ˆå™¨çª—å£ã€‚
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('experiment-container').innerHTML = html;
        }

        // ==================== å¯åŠ¨å®éªŒ ====================
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ˜¾ç¤ºæŒ‡å¯¼è¯­
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showInstructions);
        } else {
            showInstructions();
        }
    </script>
</body>

</html>


